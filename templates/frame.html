{% if cat.frames %}
{% for frame in cat.frames %}
    {% if cat.glass_units %}
        {% set thickness_list = [] %}
        {% for unit in cat.glass_units %}
            {% if unit.glass_type == 'sgu' %}
                {% set _ = thickness_list.append(unit.thickness) %}
            {% elif unit.glass_type in ['dgu', 'lgu'] %}
                {% set _ = thickness_list.append(unit.thickness1 + unit.thickness2) %}
            {% elif unit.glass_type in ['ldgu'] %}
                {% set _ = thickness_list.append(unit.thickness1_1 + unit.thickness1_2 + unit.thickness2) %}
            {% endif %}
        {% endfor %}
        {% set glass_thk = thickness_list | max %}
    {% endif %}
    
    {% if cat.connections %}
        {% set conn = cat.connections[0] %}
    {% endif %}
    
    {% if cat.anchorage %}
        {% set anchor = cat.anchorage[0] %}
    {% endif %}

    {% if frame.frame_type == "Fin Frame" %}
        {% include "partials/fin-frame.html" %}
    
    {% else %}
        {% set mullion_profile = namespace(data=none) %}
        {% if frame.mullion and alum_profiles_data %}
            {% for profile in alum_profiles_data %}
                {% if profile.profile_name == frame.mullion %}
                    {% set mullion_profile.data = profile %}
                {% endif %}
            {% endfor %}
        {% endif %}
        
        {% set transom_profile = namespace(data=none) %}
        {% if frame.transom and alum_profiles_data %}
            {% for profile in alum_profiles_data %}
                {% if profile.profile_name == frame.transom %}
                    {% set transom_profile.data = profile %}
                {% endif %}
            {% endfor %}
        {% endif %}
        
        {% set steel_profile = namespace(data=none) %}
        {% if frame.steel %}
            {# try category-scoped list first, fall back to top-level steel_profiles #}
            {% set steel_pool = cat.steel_profiles | default(steel_profiles | default([])) %}
            {% for profile in steel_pool %}
                {% if profile.profile_name | trim | lower == frame.steel | trim | lower %}
                    {% set steel_profile.data = profile %}
                {% endif %}
            {% endfor %}
        {% endif %}

        {% set mul_w_dead = ((glass_thk | default(0)) * 0.025 * frame.width / 1000) | round(2) %}
        {% set mul_w_wind = (frame.wind_neg * frame.width / 1000) | round(2) %}
        {% set mul_mu = (1.6 * mul_w_wind * (frame.length / 1000)**2 / 8) | round(2) %}+
        
        {% if frame.mullion_type == "Aluminum + Steel" %}
            {% set I_xa = mullion_profile.data.I_xx %}
            {% set mul_phi_Mn_a = mullion_profile.data.phi_Mn %}
            {% if steel_profile.data %}
                {% set I_xs = ((steel_profile.data.flange_length * steel_profile.data.web_length**3 / 12) - ((steel_profile.data.flange_length - 2 * steel_profile.data.thk) * (steel_profile.data.web_length - 2 * steel_profile.data.thk)**3 ) / 12) | round(1) %}
                {% set Y_s = steel_profile.data.web_length / 2 %}
                {% set Z_xs = (((steel_profile.data.flange_length * steel_profile.data.web_length**2) - ((steel_profile.data.flange_length - 2 * steel_profile.data.thk) * (steel_profile.data.web_length - 2 * steel_profile.data.thk)**2)) / 4) | round(1) %}
                {% set Mn_s = (Z_xs * 318 / 1000000) | round(2) %}
                {% set mul_phi_Mn_s = (0.9 * Mn_s) | round(2) %}
            {% else %}
                {% set I_xs = 0 %}
                {% set mul_phi_Mn_s = 0 %}
            {% endif %}
            {% set mul_Ix = I_xa + 3 * I_xs %}
            {% set ls_a = I_xa / mul_Ix %}
            {% set ls_s = 1 - ls_a  %}
        {% else %}
            {% set mul_Ix = mullion_profile.data.I_xx | default(0) if mullion_profile.data else 0 %}
            {% set mul_phi_Mn = mullion_profile.data.phi_Mn %}
        {% endif %}
        
        {% if frame.frame_type == 'Floor-to-floor' %}
            {% set mul_vu = (1.6 * mul_w_wind * (frame.length / 1000) / 2) | round(2) %}
            {% set mul_def = ((5 * 0.7 * mul_w_wind * (frame.length)**4) / (384 * 70000 * mul_Ix)) | round(2) %}
            {% set reaction_Ry = mul_vu | round(2) %}
            {% set reaction_Rz = (mul_w_dead / 2) | round(2) %}
        {% elif frame.frame_type == 'Continuous' %}
            {% set mul_vu = (1.6 * mul_w_wind * (frame.length / 1000) * (5 / 8)) | round(2) %}
            {% set mul_def = ((0.7 * mul_w_wind * (frame.length)**4) / (185 * 70000 * mul_Ix)) | round(2) %}
            {% set reaction_Ry = mul_w_wind * (frame.length / 1000) * (10 / 8) | round(2) %}
            {% set reaction_Rz = (mul_w_dead) | round(2) %}
        {% endif %}

        {% if frame.tran_spacing != frame.length and frame.frame_type != 'Floor-to-floor' %}
            {% set tran_w_dead = (glass_thk * 0.025) * (frame.width / 1000) %}
            {% set tran_w_wind = frame.wind_neg * (frame.width / 1000) %}
        {% else %}
            {% set tran_w_dead = ((glass_thk | default(0)) * 0.025 / 2) * (frame.width / 1000) %}
            {% set tran_w_wind = (frame.wind_neg / 2) * (frame.width / 1000) %}
        {% endif %}

        {% set tran_mu = (1.6 * tran_w_wind * (frame.width / 1000)**2 / 12) | round(2) %}
        {% set tran_vu = (1.6 * tran_w_wind * (frame.width / 1000) / 4) | round(2) %}
        {% set tran_def_wind = ((5 * 0.7 * tran_w_wind * (frame.width / 1000)**4) / (384 * 70000 * (transom_profile.data.I_xx | default(1) if transom_profile.data else 1))) | round(2) %}
        {% set tran_def_dead = ((5 * tran_w_dead * (frame.width / 1000)**4) / (384 * 70000 * (transom_profile.data.I_yy | default(1) if transom_profile.data else 1))) | round(2) %}
        {% set tran_phi_Mn = transom_profile.data.phi_Mn %}
        {% set joint_fy = ((tran_w_wind * frame.width / 1000) / 4) | round(2) %}
        {% set joint_fz = ((tran_w_dead * frame.width / 1000) / 4) | round(2) %}

        {% if frame.length <= 4100 %}
            {% set mul_allow_def = frame.length / 175 %}
        {% else %}
            {% set mul_allow_def = (frame.length / 240) + 6.35 %}
        {% endif %}
        {% set tran_allow_def = frame.width / 175 %}

        {% if frame.mullion_type == "Aluminum + Steel" %}
            {% set mul_mu_a = mul_mu * ls_a %}
            {% set mul_mu_s = mul_mu * ls_s %}
            {% set mul_dc_ratio_a = mul_mu_a / mul_phi_Mn_a %}
            {% set mul_dc_ratio_s = mul_mu_s / mul_phi_Mn_s %}
        {% else %}
            {% set mul_dc_ratio = mul_mu / mul_phi_Mn %}
        {% endif %}
        {% set tran_dc_ratio = tran_mu / tran_phi_Mn %}

        {% include "partials/typ-frame.html" %}
    {% endif %}

{% endfor %}
{% endif %}

